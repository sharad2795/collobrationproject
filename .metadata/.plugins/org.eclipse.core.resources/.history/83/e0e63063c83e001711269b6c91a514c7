'use strict';

app.controller('usercontroller',['$scope','userservice','$location','$rootScope','$cookieStore','$http',
						function($scope, userservice, $location, $rootScope,$cookieStore, $http)
						{
							console.log("inside UserController...")
						//	var this = this;
							this.user = {
								id : '',
								name : '',
								password : '',
								confirmpassword : '',
								contact : '',
								address : '',
								email : '',
								//isOnline : '',
								role : '',
								errorcode : '',
								errormessage : '',
								
							};
							
							this.currentUser = 
							{
									id : '',
									name : '',
									password : '',
									confirmpassword : '',
									contact : '',
									address : '',
									email : '',
									//isOnline : '',
									role : '',
									errorcode : '',
									errormessage : '',
									
							};

								this.users = []; // json array

								$scope.orderByMe = function(x) {
									$scope.myOrderBy = x;
								}

								this.fetchAllUsers = function()
								{
									console.log("fetchAllUsers...")
									userservice
											.fetchAllUsers()
											.then(
													function(d) {
														this.users = d;
													},
													function(errResponse) {
														console.error('Error while fetching Users');
													});
								};


							this.createUser = function(user) {
								console.log("createUser...")
								userservice.createUser(user)
										.then(
												function(d) {
													alert("Thank you for registration")
													$location.path("/")
												},
												function(errResponse) {
													console
															.error('Error while creating User.');
												});
							};

							this.updateuser=function(currentuser)
							{
								console.log("starting of update user")
								userservice.
							}
							
							this.submit = function() {
								{
									console.log('Saving New User', this.user);
									this.createUser(this.user);
								}
								this.reset();
							};
							
							this.login = function() {
								{
									console.log('login validation????????',
											this.user);
									this.authenticate(this.user);
								}

							};
							
							
								this.logout = function() 
							{
								console.log("logout")
								$rootScope.currentUser = {};
								$cookieStore.remove('currentUser');
								userservice.logout()
								$location.path('/');

							};



							this.reset = function() {
								this.user = {
									id : '',
									name : '',
									password : '',
									confirmpassword : '',
									contact : '',
									address : '',
									email : '',
									role:'',
									errorcode : '',
									errormessage : ''
								};
								$scope.myForm.$setPristine(); // reset Form
							};
							
							
							this.authenticate = function(user) 
							{
								console.log("inside authenticate funtion...")
								userservice.authenticate(user)
										.then(

												function(d)
												{

													user = d;
													console.log("user.errorCode: "+ user.errorCode)
													if (user.errorcode == "404")

													{
														alert(user.errormessage)

														user.id = "";
														user.password = "";

													}
													else 
													{ // valid
																// credentials
														console.log("Valid credentials. Navigating to home page")
														$location.path("/")
														if(user.role=="admin")	
															{
																console.log("You are admin")
														
															}
														
														console.log('Current user : '+ user)
														$rootScope.currentUser = user
														$cookieStore.put('currentUser',user);

													}
												});
											};
						} ]);
